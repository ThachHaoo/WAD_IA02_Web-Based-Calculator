<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Windows 11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            transition: all 0.1s ease;
        }
        .btn:active {
            transform: scale(0.96);
        }

        #button-grid {
            display: grid;
            grid-template-rows: auto repeat(6, 1fr); /* Hàng memory auto, 6 hàng còn lại 1fr */
            flex-grow: 1; /* Cho phép lưới nút phát triển */
        }
        .btn {
            height: 100%; /* Làm cho các nút lấp đầy ô lưới */
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center h-screen p-0 lg:pt-10 lg:pb-10">

    <!-- Lớp phủ (overlay) cho modal trên di động -->
    <div id="mobile-history-overlay" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-40 lg:hidden"></div>

    <div class="flex flex-col lg:flex-row w-full mx-auto lg:space-x-6 lg:space-y-0 h-full p-4 lg:p-0">

        <div class="bg-gray-200/60 backdrop-blur-md p-3 rounded-xl shadow-lg w-full flex-1 flex flex-col relative">
            
            <div class="w-full px-4 pt-8 pb-4 flex-shrink-0 relative">
                
                <button id="history-toggle" title="History (Ctrl+H)" class="absolute top-0 right-3 p-2 rounded-md hover:bg-gray-300/80 text-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zM12.983 3.017a.5.5 0 0 1 .011.002l.994-.074A8 8 0 0 1 15 8h-1A7 7 0 0 0 12.983 3.017zM13 8a5 5 0 0 0-10 0H2a6 6 0 0 1 12 0h-1zm-.002 4.95A.5.5 0 0 1 12.983 12.983l.074.994A8 8 0 0 1 8 16v-1A7 7 0 0 0 12.998 12.95zM3.017 12.983a.5.5 0 0 1-.011-.002l-.994.074A8 8 0 0 1 1 8h1a7 7 0 0 0 1.017 4.983z"/>
                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                        <path d="M6.5 1A.5.5 0 0 1 7 .5h2a.5.5 0 0 1 0 1H7a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                </button>
                
                <div class="w-full text-right px-4  flex-shrink-0">
                    <div id="history-display" class="h-7 text-gray-500 text-lg">&nbsp;</div>
                    <div id="main-display" class="text-5xl font-bold truncate">0</div>
                </div>
            </div>

            <div id="button-grid" class="grid grid-cols-4 gap-2 text-center w-full">
                <!-- THAY ĐỔI: Thêm ID và trạng thái disabled cho các nút memory -->
                <div class="col-span-4 grid grid-cols-6 lg:grid-cols-5 text-sm font-medium">
                    <button id="btn-mc" class="flex-1 py-2 rounded-md hover:bg-gray-300/80 transition-colors disabled:opacity-50 disabled:hover:bg-transparent" disabled>MC</button>
                    <button id="btn-mr" class="flex-1 py-2 rounded-md hover:bg-gray-300/80 transition-colors disabled:opacity-50 disabled:hover:bg-transparent" disabled>MR</button>
                    <button id="btn-m-plus" class="flex-1 py-2 rounded-md hover:bg-gray-300/80 transition-colors">M+</button>
                    <button id="btn-m-minus" class="flex-1 py-2 rounded-md hover:bg-gray-300/80 transition-colors">M-</button>
                    <button id="btn-ms" class="flex-1 py-2 rounded-md hover:bg-gray-300/80 transition-colors">MS</button>
                    <button id="btn-m-dropdown" class="lg:hidden flex-1 py-2 rounded-md hover:bg-gray-300/80 transition-colors disabled:opacity-50 disabled:hover:bg-transparent" disabled>M&#709;</button>
                </div>
                
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-lg rounded-lg">%</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-lg rounded-lg">CE</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-lg rounded-lg">C</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-2xl rounded-lg">⌫</button>

                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-lg rounded-lg">¹/x</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-lg rounded-lg">x²</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-lg rounded-lg">√x</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-2xl rounded-lg">÷</button>

                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">7</button>
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">8</button>
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">9</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-2xl rounded-lg">×</button>
                
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">4</button>
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">5</button>
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">6</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-2xl rounded-lg">−</button>
                
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">1</button>
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">2</button>
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">3</button>
                <button class="btn bg-gray-300/60 hover:bg-gray-300/90 text-2xl rounded-lg">+</button>
                
                <button class="btn bg-gray-50/80 hover:bg-white text-lg rounded-lg">+/-</button>
                <button class="btn bg-gray-50/80 hover:bg-white font-bold text-xl rounded-lg">0</button>
                <button class="btn bg-gray-50/80 hover:bg-white text-lg rounded-lg">.</button>
                <button class="btn bg-blue-500 hover:bg-blue-600 text-white text-2xl rounded-lg">=</button>
            </div>
        </div>

        <div id="history-panel" 
             class="hidden fixed z-50 bottom-0 left-0 right-0 w-full h-3/4 bg-gray-200/60 backdrop-blur-md p-6 rounded-t-xl shadow-lg flex flex-col
                    transition-transform duration-300 ease-in-out translate-y-full
                    lg:flex lg:static lg:z-auto lg:w-[400px] lg:h-full lg:translate-y-0 lg:rounded-xl">

            <!-- THAY ĐỔI: Thêm ID cho các nút tab -->
            <div class="flex space-x-6 border-b border-gray-300 mb-4 flex-shrink-0">
                <button id="tab-history" class="font-bold border-b-2 border-blue-500 pb-2">History</button>
                <button id="tab-memory" class="text-gray-600 pb-2">Memory</button>
            </div>

            <!-- Nội dung Lịch sử -->
            <div id="history-content" class="text-right flex-grow overflow-y-auto space-y-4 pr-4">
                <p id="no-history-message" class="text-center text-gray-500 pt-8">There's no history yet.</p>
                <!-- Các mục lịch sử sẽ được chèn vào đây -->
            </div>

            <!-- THÊM MỚI: Nội dung Bộ nhớ -->
            <div id="memory-content" class="text-right flex-grow overflow-y-auto space-y-4 pr-4 hidden">
                 <p id="no-memory-message" class="text-center text-gray-500 pt-8">There's nothing saved in memory.</p>
                 <!-- Các mục bộ nhớ sẽ được chèn vào đây -->
            </div>

            <!-- THAY ĐỔI: Thêm trình bao bọc cho các nút xóa -->
            <div class="pt-4 flex justify-end flex-shrink-0">
                <div id="clear-history-wrapper">
                    <button id="clear-history-button" class="p-2 rounded-md hover:bg-gray-300/80 text-gray-700 transition-colors" title="Clear history">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                    </button>
                </div>
                <!-- THÊM MỚI: Nút Xóa Bộ nhớ -->
                <div id="clear-memory-wrapper" class="hidden">
                     <button id="clear-memory-button" class="p-2 rounded-md hover:bg-gray-300/80 text-gray-700 transition-colors" title="Clear all memory">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. LẤY CÁC THÀNH PHẦN GIAO DIỆN ---
            const mainDisplay = document.getElementById('main-display');
            const historyDisplay = document.getElementById('history-display');
            const buttonGrid = document.getElementById('button-grid');

            // --- 2. BIẾN TRẠNG THÁI (STATE) CỦA MÁY TÍNH ---
            const historyToggle = document.getElementById('history-toggle');
            const historyPanel = document.getElementById('history-panel');
            const historyContent = document.getElementById('history-content');
            const noHistoryMessage = document.getElementById('no-history-message');
            const clearHistoryButton = document.getElementById('clear-history-button');
            const mobileHistoryOverlay = document.getElementById('mobile-history-overlay');

            // THÊM MỚI: Lấy các thành phần Bộ nhớ
            const tabHistory = document.getElementById('tab-history');
            const tabMemory = document.getElementById('tab-memory');
            const memoryContent = document.getElementById('memory-content');
            const noMemoryMessage = document.getElementById('no-memory-message');
            const clearMemoryButton = document.getElementById('clear-memory-button');
            const clearHistoryWrapper = document.getElementById('clear-history-wrapper');
            const clearMemoryWrapper = document.getElementById('clear-memory-wrapper');

            const btnMC = document.getElementById('btn-mc');
            const btnMR = document.getElementById('btn-mr');
            const btnMPlus = document.getElementById('btn-m-plus');
            const btnMMinus = document.getElementById('btn-m-minus');
            const btnMS = document.getElementById('btn-ms');
            const btnMDropdown = document.getElementById('btn-m-dropdown');

            let currentOperand = '0';
            let previousOperand = '';
            let operation = undefined;
            let readyToReset = false;
            
            let unaryHistory = undefined;
            let lastFullEquation = undefined;
            let calculationHistory = [];
            
            let lastOperationForEquals = undefined;
            let lastOperandForEquals = undefined;

            // THÊM MỚI: Biến trạng thái cho Bộ nhớ
            let memoryHistory = []; // Sẽ lưu một danh sách các số

            // --- 3. HÀM CẬP NHẬT GIAO DIỆN ---
            
            function getFormattedNumber(numberString) {
                if (numberString === '' || numberString === null) numberString = '0';
                
                let formattedOperand;
                if (numberString.includes('.')) {
                    const parts = numberString.split('.');
                    const decimalPart = parts[1];
                    const integerPart = parts[0] === '' ? '0' : parts[0]; 
                    const formattedInteger = parseFloat(integerPart).toLocaleString('en-US');
                    formattedOperand = `${formattedInteger}.${decimalPart}`;
                } else {
                    formattedOperand = parseFloat(numberString).toLocaleString('en-US', {
                        maximumFractionDigits: 10
                    });
                }
                return formattedOperand;
            }
            
            function updateDisplay() {
                let valueToDisplay = currentOperand;
                if (currentOperand === '' && operation != null) {
                    valueToDisplay = previousOperand;
                }
                
                mainDisplay.innerText = getFormattedNumber(valueToDisplay);

                if (lastFullEquation) {
                    historyDisplay.innerText = lastFullEquation;
                } else if (unaryHistory) {
                    if (unaryHistory.length > 30) {
                        historyDisplay.innerText = '...' + unaryHistory.slice(-27);
                    } else {
                        historyDisplay.innerText = unaryHistory;
                    }
                } else if (operation != null) {
                    historyDisplay.innerText = `${getFormattedNumber(previousOperand)} ${operation}`;
                } else {
                    historyDisplay.innerText = '\u00A0';
                }
            }

            // --- 3.5. HÀM CẬP NHẬT GIAO DIỆN LỊCH SỬ ---
            function updateHistoryDisplay() {
                if (calculationHistory.length === 0) {
                    noHistoryMessage.classList.remove('hidden');
                    historyContent.querySelectorAll('.history-item').forEach(item => item.remove());
                } else {
                    noHistoryMessage.classList.add('hidden');
                    historyContent.querySelectorAll('.history-item').forEach(item => item.remove());

                    calculationHistory.slice().reverse().forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item py-1'; 
                        
                        const equationEl = document.createElement('div');
                        equationEl.className = 'text-gray-500 text-sm truncate';
                        equationEl.innerText = item.equation;
                        
                        const resultEl = document.createElement('div');
                        resultEl.className = 'text-xl font-bold truncate';
                        resultEl.innerText = getFormattedNumber(item.result);
                        
                        historyItem.appendChild(equationEl);
                        historyItem.appendChild(resultEl);
                        
                        historyContent.appendChild(historyItem);
                    });
                }
            }

            // --- 3.6. THÊM MỚI: HÀM CẬP NHẬT GIAO DIỆN BỘ NHỚ ---
            function updateMemoryDisplay() {
                // Xóa nội dung cũ
                memoryContent.querySelectorAll('.memory-item').forEach(item => item.remove());

                if (memoryHistory.length === 0) {
                    noMemoryMessage.classList.remove('hidden');
                    // Tắt các nút MC, MR, M_Dropdown
                    btnMC.disabled = true;
                    btnMR.disabled = true;
                    btnMDropdown.disabled = true;
                } else {
                    noMemoryMessage.classList.add('hidden');
                    // Bật các nút MC, MR, M_Dropdown
                    btnMC.disabled = false;
                    btnMR.disabled = false;
                    btnMDropdown.disabled = false;

                    // Thêm từng mục bộ nhớ vào (hiển thị ngược: mới nhất ở trên)
                    memoryHistory.forEach((memValue) => {
                        const memItem = document.createElement('div');
                        memItem.className = 'memory-item py-2';
                        
                        const memValueEl = document.createElement('div');
                        memValueEl.className = 'text-2xl font-bold truncate';
                        memValueEl.innerText = getFormattedNumber(memValue.toString());
                        
                        // TODO: Có thể thêm các nút M+, M-, MC cho từng mục ở đây
                        
                        memItem.appendChild(memValueEl);
                        // Chèn vào đầu để mục mới nhất ở trên cùng
                        // THAY ĐỔI: Đổi .prepend() thành .appendChild() để hiển thị đúng thứ tự
                        // (mục mới nhất memoryHistory[0] sẽ ở trên cùng)
                        memoryContent.appendChild(memItem); 
                    });
                }
            }

            // --- 4. HÀM TÍNH TOÁN ---
            function calculate() {
                
                if (operation === undefined && lastOperationForEquals !== undefined) {
                    operation = lastOperationForEquals;
                    previousOperand = currentOperand;
                    currentOperand = lastOperandForEquals;
                }

                let computation;
                const prev = parseFloat(previousOperand);
                const current = parseFloat(currentOperand);

                if (isNaN(prev) || isNaN(current)) return true;

                lastOperationForEquals = operation;
                lastOperandForEquals = currentOperand;

                lastFullEquation = `${getFormattedNumber(previousOperand)} ${operation} ${getFormattedNumber(currentOperand)} =`;
                unaryHistory = undefined;

                switch (operation) {
                    case '+':
                        computation = prev + current;
                        break;
                    case '−':
                    case '-':
                        computation = prev - current;
                        break;
                    case '×':
                        computation = prev * current;
                        break;
                    case '÷':
                        if (current === 0) {
                            mainDisplay.innerText = 'Cannot divide by zero';
                            lastOperationForEquals = undefined; 
                            lastOperandForEquals = undefined;
                            readyToReset = true; 
                            return false; 
                        }
                        computation = prev / current;
                        break;
                    default:
                        return true; 
                }

                const resultString = computation.toString();

                calculationHistory.push({
                    equation: lastFullEquation,
                    result: resultString
                });
                updateHistoryDisplay();

                currentOperand = resultString;
                operation = undefined;
                previousOperand = '';
                readyToReset = true; 
                return true; 
            }

            // --- 5. HÀM CHỌN PHÉP TOÁN ---
            function chooseOperation(op) {
                lastFullEquation = undefined;
                lastOperationForEquals = undefined;
                lastOperandForEquals = undefined;
                readyToReset = false;

                if (currentOperand === '' && previousOperand === '') return;
                
                if (currentOperand === '' && previousOperand !== '') {
                    operation = op;
                    unaryHistory = undefined;
                    return;
                }

                if (previousOperand !== '') {
                    calculate();
                    updateDisplay();
                }

                operation = op;
                previousOperand = currentOperand;
                currentOperand = '';
                unaryHistory = undefined;
            }

            // --- 6. HÀM THÊM SỐ VÀO MÀN HÌNH ---
            function appendNumber(number) {
                if (readyToReset) {
                    currentOperand = '';
                    readyToReset = false;
                    lastFullEquation = undefined;
                    unaryHistory = undefined;
                    lastOperationForEquals = undefined;
                    lastOperandForEquals = undefined;
                }

                if (currentOperand === '' && operation != null) {
                    currentOperand = number;
                    unaryHistory = undefined;
                    return; 
                }

                if (currentOperand === '0' && number === '0') return;
                if (currentOperand === '0' && number !== '0' && !currentOperand.includes('.')) {
                    currentOperand = number;
                    return;
                }
                
                if (currentOperand.length > 15) return;

                currentOperand = currentOperand.toString() + number.toString();
            }
            
            // --- 7. CÁC HÀM XỬ LÝ NÚT KHÁC ---
            
            function clearAll() {
                currentOperand = '0';
                previousOperand = '';
                operation = undefined;
                readyToReset = false;
                lastFullEquation = undefined;
                unaryHistory = undefined;
                lastOperationForEquals = undefined;
                lastOperandForEquals = undefined;
            }

            function clearEntry() {
                currentOperand = '0';
                readyToReset = false;
                unaryHistory = undefined;
            }
            
            function backspace() {
                if (readyToReset) {
                    clearAll();
                    updateDisplay();
                    return;
                }
                currentOperand = currentOperand.toString().slice(0, -1);
                unaryHistory = undefined;
                lastOperationForEquals = undefined;
                lastOperandForEquals = undefined;
                
                if (currentOperand === '') {
                    currentOperand = '0';
                }
            }
            
            function addDecimal() {
                if (readyToReset) {
                    currentOperand = '0';
                    readyToReset = false;
                    lastFullEquation = undefined;
                    unaryHistory = undefined;
                    lastOperationForEquals = undefined;
                    lastOperandForEquals = undefined;
                }
                
                if (currentOperand === '' && operation != null) {
                    currentOperand = '0.';
                    unaryHistory = undefined;
                    return;
                }

                if (currentOperand.includes('.')) return;
                currentOperand = currentOperand + '.';
            }
            
            function negate() {
                if (currentOperand === '0') return;
                currentOperand = (parseFloat(currentOperand) * -1).toString();
                unaryHistory = undefined;
            }

            function handleUnaryOperation(op) {
                lastFullEquation = undefined;
                lastOperationForEquals = undefined;
                lastOperandForEquals = undefined;
                
                const current = parseFloat(currentOperand);
                if (isNaN(current)) return true;
                
                let baseValue = unaryHistory ? unaryHistory : parseFloat(currentOperand).toString();
                let result;
                switch(op) {
                    case '%':
                        if (previousOperand !== '') {
                            result = parseFloat(previousOperand) * (current / 100);
                        } else {
                            result = 0;
                        }
                        unaryHistory = undefined;
                        break;
                    case '¹/x':
                        if (current === 0) {
                            mainDisplay.innerText = 'Cannot divide by zero';
                            readyToReset = true;
                            return false;
                        }
                        result = 1 / current;
                        unaryHistory = `1/(${baseValue})`;
                        break;
                    case 'x²':
                        result = current * current;
                        unaryHistory = `sqr(${baseValue})`;
                        break;
                    case '√x':
                        if (current < 0) {
                            mainDisplay.innerText = 'Invalid input';
                            readyToReset = true;
                            return false;
                        }
                        result = Math.sqrt(current);
                        unaryHistory = `√(${baseValue})`;
                        break;
                    default:
                        return true;
                }
                currentOperand = result.toString();
                readyToReset = true; 
                return true;
            }

            // --- 7.5. THÊM MỚI: CÁC HÀM XỬ LÝ BỘ NHỚ ---
        
            // MC - Memory Clear
            function memoryClear() {
                memoryHistory = [];
                updateMemoryDisplay();
            }

            // MR - Memory Recall
            function memoryRecall() {
                if (memoryHistory.length > 0) {
                    // Lấy mục mới nhất (mục đầu tiên trong mảng)
                    currentOperand = memoryHistory[0].toString();
                    readyToReset = true;
                    lastFullEquation = undefined;
                    unaryHistory = undefined;
                }
            }

            // MS - Memory Store
            function memoryStore() {
                const current = parseFloat(currentOperand);
                if (isNaN(current)) return;
                
                // Thêm vào đầu danh sách (mục mới nhất)
                memoryHistory.unshift(current);
                
                // Giới hạn bộ nhớ (tùy chọn)
                if (memoryHistory.length > 100) {
                    memoryHistory.pop();
                }
                
                readyToReset = true;
                updateMemoryDisplay();
            }

            // M+ - Memory Add
            function memoryAdd() {
                const current = parseFloat(currentOperand);
                if (isNaN(current)) return;

                if (memoryHistory.length === 0) {
                    // Nếu chưa có gì, hoạt động như MS
                    memoryHistory.unshift(current);
                } else {
                    // Cộng vào mục đầu tiên (mới nhất)
                    memoryHistory[0] = memoryHistory[0] + current;
                }
                readyToReset = true;
                updateMemoryDisplay();
            }

            // M- - Memory Subtract
            function memorySubtract() {
                const current = parseFloat(currentOperand);
                if (isNaN(current)) return;

                if (memoryHistory.length === 0) {
                    // Nếu chưa có gì, lưu giá trị âm
                    memoryHistory.unshift(-current);
                } else {
                    // Trừ khỏi mục đầu tiên (mới nhất)
                    memoryHistory[0] = memoryHistory[0] - current;
                }
                readyToReset = true;
                updateMemoryDisplay();
            }

            // --- 8. BỘ LẮNG NGHE SỰ KIỆN (EVENT LISTENER) ---
            buttonGrid.addEventListener('click', (e) => {
                if (!e.target.matches('button')) return;

                const button = e.target;
                const action = button.innerText;
                
                let shouldUpdateDisplay = true;

                if (/\d/.test(action)) {
                    appendNumber(action);
                } else if (action === '.') {
                    addDecimal();
                } else if (action === '=') {
                    shouldUpdateDisplay = calculate();
                } else if (action === 'C') {
                    clearAll();
                } else if (action === 'CE') {
                    clearEntry();
                } else if (action === '⌫') {
                    backspace();
                } else if (action === '+/-') {
                    negate();
                } else if (['+', '−', '-', '×', '÷'].includes(action)) {
                    chooseOperation(action);
                } else if (['%', '¹/x', 'x²', '√x'].includes(action)) {
                    shouldUpdateDisplay = handleUnaryOperation(action);
                // THÊM MỚI: Xử lý các nút Memory
                } else if (action === 'MC') {
                    memoryClear();
                    shouldUpdateDisplay = false; 
                } else if (action === 'MR') {
                    memoryRecall();
                    // shouldUpdateDisplay mặc định là true, sẽ cập nhật main display
                } else if (action === 'MS') {
                    memoryStore();
                    shouldUpdateDisplay = false;
                } else if (action === 'M+') {
                    memoryAdd();
                    shouldUpdateDisplay = false; 
                } else if (action === 'M-') {
                    memorySubtract();
                    shouldUpdateDisplay = false; 
                }
                
                if (shouldUpdateDisplay) {
                    updateDisplay();
                }
            });

            // --- 9. BỘ LẮNG NGHE SỰ KIỆN BÀN PHÍM ---
            document.addEventListener('keydown', (e) => {
                const key = e.key;
                
                if (e.ctrlKey && (e.key.toLowerCase() === 'h' || e.key.toLowerCase() === 'H')) {
                    e.preventDefault(); 
                    
                    if (window.innerWidth >= 1024) {
                        historyPanel.classList.toggle('hidden');
                    } else {
                        const isHidden = historyPanel.classList.contains('hidden') || historyPanel.classList.contains('translate-y-full');
                        if (isHidden) {
                            showMobileHistory();
                        } else {
                            hideMobileHistory();
                        }
                    }
                    return;
                }
                
                // THÊM MỚI: Phím tắt cho bộ nhớ (Ctrl+M, Ctrl+Q, Ctrl+P, Ctrl+L, Ctrl+R)
                if (e.ctrlKey) {
                    e.preventDefault();
                    switch(e.key.toLowerCase()) {
                        case 'l': // Clear
                            memoryClear();
                            return;
                        case 'r': // Recall
                            memoryRecall();
                            updateDisplay();
                            return;
                        case 'm': // Store
                            memoryStore();
                            return;
                        case 'p': // Add
                            memoryAdd();
                            return;
                        case 'q': // Subtract
                            memorySubtract();
                            return;
                    }
                }


                let shouldUpdateDisplay = true;

                if (/\d/.test(key)) {
                    appendNumber(key);
                } else if (key === '.') {
                    addDecimal();
                } else if (key === '=' || key === 'Enter') {
                    shouldUpdateDisplay = calculate();
                } else if (key === 'Escape') { 
                    clearAll();
                } else if (key.toLowerCase() === 'c') {
                    clearEntry();
                } else if (key === 'Backspace') {
                    backspace();
                } else if (key === '+') {
                    chooseOperation('+');
                } else if (key === '-') {
                    chooseOperation('−');
                } else if (key === '*') {
                    chooseOperation('×');
                } else if (key === '/') {
                    e.preventDefault();
                    chooseOperation('÷');
                } else if (key === '%') {
                    shouldUpdateDisplay = handleUnaryOperation('%');
                } else if (key === '@') {
                    shouldUpdateDisplay = handleUnaryOperation('√x');
                } else if (key.toLowerCase() === 'q' && !e.ctrlKey) { // Đảm bảo không xung đột với Ctrl+Q
                    shouldUpdateDisplay = handleUnaryOperation('x²');
                } else if (key.toLowerCase() === 'r' && !e.ctrlKey) { // Đảm bảo không xung đột với Ctrl+R
                    shouldUpdateDisplay = handleUnaryOperation('¹/x');
                }
                
                if (shouldUpdateDisplay) {
                    updateDisplay();
                }
            });

            // --- 10. BỘ LẮNG NGHE CÁC NÚT LỊCH SỬ (VÀ CÁC HÀM HELPER MỚI) ---
            
            function showMobileHistory() {
                mobileHistoryOverlay.classList.remove('hidden');
                historyPanel.classList.remove('hidden');
                setTimeout(() => {
                    historyPanel.classList.remove('translate-y-full');
                }, 20); 
            }

            function hideMobileHistory() {
                historyPanel.classList.add('translate-y-full');
                setTimeout(() => {
                    mobileHistoryOverlay.classList.add('hidden');
                    historyPanel.classList.add('hidden');
                }, 300);
            }

            historyToggle.addEventListener('click', () => {
                if (window.innerWidth >= 1024) {
                    historyPanel.classList.toggle('hidden');
                } else {
                    showMobileHistory();
                }
            });

            mobileHistoryOverlay.addEventListener('click', () => {
                hideMobileHistory();
            });

            clearHistoryButton.addEventListener('click', () => {
                calculationHistory = [];
                updateHistoryDisplay();
            });

            // --- 11. THÊM MỚI: BỘ LẮNG NGHE CHUYỂN TAB (HISTORY/MEMORY) ---
        
            function showHistoryTab() {
                // Nội dung
                historyContent.classList.remove('hidden');
                memoryContent.classList.add('hidden');
                
                // Nút Clear
                clearHistoryWrapper.classList.remove('hidden');
                clearMemoryWrapper.classList.add('hidden');

                // Kiểu tab
                tabHistory.classList.add('font-bold', 'border-b-2', 'border-blue-500');
                tabHistory.classList.remove('text-gray-600');
                tabMemory.classList.remove('font-bold', 'border-b-2', 'border-blue-500');
                tabMemory.classList.add('text-gray-600');
            }

            function showMemoryTab() {
                // Nội dung
                historyContent.classList.add('hidden');
                memoryContent.classList.remove('hidden');

                // Nút Clear
                clearHistoryWrapper.classList.add('hidden');
                clearMemoryWrapper.classList.remove('hidden');

                // Kiểu tab
                tabHistory.classList.remove('font-bold', 'border-b-2', 'border-blue-500');
                tabHistory.classList.add('text-gray-600');
                tabMemory.classList.add('font-bold', 'border-b-2', 'border-blue-500');
                tabMemory.classList.remove('text-gray-600');
                
                // Cập nhật hiển thị bộ nhớ khi chuyển qua
                updateMemoryDisplay();
            }

            tabHistory.addEventListener('click', showHistoryTab);
            tabMemory.addEventListener('click', showMemoryTab);

            // THÊM MỚI: Listener cho nút xóa bộ nhớ
            clearMemoryButton.addEventListener('click', () => {
                memoryClear(); // Hàm này đã gọi updateMemoryDisplay()
            });


            // --- 12. KHỞI CHẠY ---
            updateHistoryDisplay();
            updateMemoryDisplay(); // THÊM MỚI
            updateDisplay();
        });
    </script>
    </body>
</html>